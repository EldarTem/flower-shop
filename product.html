<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pure azure — Roses from Edem</title>

    <link rel="stylesheet" href="assets/css/base.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/libs/swiper/swiper-bundle.min.css" />
    <link rel="stylesheet" href="assets/css/product-card.css" />
    <link rel="stylesheet" href="assets/css/cart.css" />
    <link
      rel="icon"
      href="/assets/images/icons/favicon.svg"
      type="image/svg+xml"
    />
  </head>
  <body>
    <!-- header -->
    <div id="header-placeholder"></div>

    <main class="container product">
      <div class="product__grid">
        <!-- MEDIA -->
        <section class="product__media" aria-label="Фотографии букета">
          <div class="product__photo">
            <img
              id="product-main"
              src="assets/images/izobr/goods_01.jpg"
              alt="Букет Pure azure — крупный план"
            />
          </div>

          <ul class="product__thumbs" role="list" id="product-thumbs">
            <li>
              <button
                class="thumb is-active"
                data-full="assets/images/izobr/goods_01.jpg"
              >
                <img src="assets/images/izobr/goods_01.jpg" alt="Фото 1" />
              </button>
            </li>
            <li>
              <button
                class="thumb"
                data-full="assets/images/izobr/cert-1-1.jpg"
              >
                <img src="assets/images/izobr/cert-1-1.jpg" alt="Фото 2" />
              </button>
            </li>
            <li>
              <button class="thumb" data-full="assets/images/izobr/cert-1.jpg">
                <img src="assets/images/izobr/cert-1.jpg" alt="Фото 3" />
              </button>
            </li>
            <li>
              <button class="thumb" data-full="assets/images/izobr/cert-3.jpg">
                <img src="assets/images/izobr/cert-3.jpg" alt="Фото 4" />
              </button>
            </li>
          </ul>
        </section>

        <!-- SUMMARY -->
        <section class="product__summary">
          <h1 class="product__title">Pure azure</h1>

          <div class="product__price-row">
            <div class="product__price">5&nbsp;000&nbsp;₽</div>
            <a href="#" class="btn btn--primary">Заказать</a>
          </div>

          <div class="product__desc">Нежный букет собран на вкус флориста.</div>

          <div class="product__section">
            <h2 class="product__subtitle">Состав</h2>
            <p>Кустовая роза, одноголовая хризантема, георгины, эвкалипт.</p>
          </div>

          <div class="product__section">
            <h2 class="product__subtitle">К букету можно добавить</h2>
            <ul class="product__list" role="list">
              <li>открытку с пожеланием (бесплатно);</li>
              <li>транспортировочный бокс с водой;</li>
              <li>секатор;</li>
              <li>вазу.</li>
            </ul>
          </div>

          <p class="product__note">
            Цветы могут быть сезонными или временно отсутствовать. В случае их
            нежелания мы обсудим с вами возможную замену при подтверждении
            заказа.
          </p>
        </section>
      </div>
      <!-- 1) Дополнения -->
      <section class="popular container" data-slider="addons">
        <h2 class="popular__title">ДОПОЛНЕНИЯ</h2>
        <div class="popular__slider-wrap">
          <button class="popular-nav popular-prev" aria-label="Предыдущие">
            <img src="assets/images/icons/arrowLeft.svg" alt="" />
          </button>
          <button class="popular-nav popular-next" aria-label="Следующие">
            <img src="assets/images/icons/arrowRight.svg" alt="" />
          </button>

          <div class="swiper popular-swiper">
            <div class="swiper-wrapper"><!-- js --></div>
          </div>
        </div>
      </section>

      <!-- 2) Похожие букеты -->
      <section class="popular container" data-slider="similar">
        <h2 class="popular__title">ПОХОЖИЕ БУКЕТЫ</h2>
        <div class="popular__slider-wrap">
          <button class="popular-nav popular-prev" aria-label="Предыдущие">
            <img src="assets/images/icons/arrowLeft.svg" alt="" />
          </button>
          <button class="popular-nav popular-next" aria-label="Следующие">
            <img src="assets/images/icons/arrowRight.svg" alt="" />
          </button>

          <div class="swiper popular-swiper">
            <div class="swiper-wrapper"><!-- js --></div>
          </div>
        </div>
      </section>
    </main>
    <button id="to-top" class="to-top" type="button" aria-label="Наверх">
      <img src="assets/images/icons/arrowLeft.svg" alt="" />
    </button>
    <!-- footer -->
    <div id="footer-placeholder"></div>

    <script src="assets/libs/swiper/swiper-bundle.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/cart.js"></script>
    <script>
      (function () {
        const orderBtn = document.querySelector(".btn.btn--primary");
        if (!orderBtn) return;

        // парсер цены вида "5 000 ₽" -> 5000
        function parsePrice(s) {
          return (
            Number(
              String(s || "")
                .replace(/\u00A0|&nbsp;|₽|\s/g, "")
                .replace(",", ".")
            ) || 0
          );
        }

        // собираем объект товара со страницы
        function buildItemFromPage() {
          const title =
            document.querySelector(".product__title")?.textContent.trim() ||
            "Товар";
          const price = parsePrice(
            document.querySelector(".product__price")?.textContent || "0"
          );
          const img =
            document.getElementById("product-main")?.getAttribute("src") || "";
          const href = location.pathname + location.search;
          const sku = new URLSearchParams(location.search).get("sku");
          const excerpt =
            document.querySelector(".product__desc")?.textContent.trim() || "";

          // стабильный id: предпочитаем ?sku=, иначе из заголовка
          const id =
            sku ||
            "product-" +
              btoa(unescape(encodeURIComponent(title)))
                .replace(/=+$/, "")
                .slice(0, 12);

          return { id, title, price, img, href, excerpt };
        }

        // создаём/получаем скрытую карточку с кнопкой data-add-to-cart
        function ensureShadowCard() {
          let card = document.getElementById("product-shadow-card");
          if (!card) {
            card = document.createElement("a");
            card.id = "product-shadow-card";
            card.className = "product-card";
            card.href = "#";
            card.style.display = "none";
            card.innerHTML = '<button type="button" data-add-to-cart></button>';
            document.body.appendChild(card);
          }
          return card;
        }

        orderBtn.addEventListener("click", function (e) {
          e.preventDefault();

          const item = buildItemFromPage();
          const card = ensureShadowCard();
          card.setAttribute("data-product", JSON.stringify(item));

          // триггерим общий обработчик добавления в корзину
          const btn = card.querySelector("[data-add-to-cart]");
          btn?.click();

          // визуальный отклик на самой кнопке «Заказать»
          const prev = orderBtn.innerHTML;
          orderBtn.classList.add("is-added");
          orderBtn.innerHTML = "Добавлено&nbsp;✓";
          orderBtn.style.transform = "scale(0.98)";
          setTimeout(() => (orderBtn.style.transform = ""), 120);
          setTimeout(() => {
            orderBtn.classList.remove("is-added");
            orderBtn.innerHTML = prev;
          }, 1200);
        });
      })();
    </script>

    <script>
      (function () {
        const box = document.querySelector(".product__photo");
        let main = document.getElementById("product-main");
        const thumbsWrap = document.getElementById("product-thumbs");

        if (!box || !thumbsWrap) return;

        // безопасная установка главного изображения (c предзагрузкой и фолбэком)
        function setMainImage(url, alt) {
          if (!url) return;

          // если главного <img> нет — создадим
          if (!main) {
            main = document.createElement("img");
            main.id = "product-main";
            main.alt = alt || "";
            main.decoding = "async";
            main.loading = "eager";
            box.classList.remove("is-empty");
            box.innerHTML = "";
            box.appendChild(main);
          }

          const probe = new Image();
          probe.onload = () => {
            box.classList.remove("is-empty");
            main.src = url;
            if (alt) main.alt = alt;
          };
          probe.onerror = () => {
            // если картинка битая — показываем плейсхолдер
            box.classList.add("is-empty");
            if (main) {
              main.remove();
              main = null;
            }
          };
          probe.src = url;
        }

        // делегируем клики на список миниатюр
        thumbsWrap.addEventListener("click", (e) => {
          const btn = e.target.closest(".thumb");
          if (!btn) return;

          e.preventDefault();

          const imgEl = btn.querySelector("img");
          const full = btn.dataset.full || imgEl?.getAttribute("src");
          const alt = imgEl?.getAttribute("alt") || "";

          // активное состояние
          thumbsWrap
            .querySelectorAll(".thumb.is-active")
            .forEach((t) => t.classList.remove("is-active"));
          btn.classList.add("is-active");

          setMainImage(full, alt);
        });

        // синхронизируем active при загрузке (если main уже есть)
        if (main && main.src) {
          const curr = Array.from(thumbsWrap.querySelectorAll(".thumb")).find(
            (t) => (t.dataset.full || t.querySelector("img")?.src) === main.src
          );
          if (curr) {
            thumbsWrap
              .querySelectorAll(".thumb.is-active")
              .forEach((t) => t.classList.remove("is-active"));
            curr.classList.add("is-active");
          }
        }
      })();
    </script>
  </body>
</html>
